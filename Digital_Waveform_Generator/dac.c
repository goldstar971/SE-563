#include <stdlib.h>
#include <math.h>
#include "dac.h"
#include "main.h"


float tri_values[128]={0, 0.079365,0.158730,0.238095,0.317460,0.396825,0.476190,0.555555,0.634920,0.714285,0.793650,
0.873015,0.952380,1.031746,1.111111,1.190476,1.269841,1.349206,1.428571,1.507936,1.587301,
1.666666,1.746031,1.825396,1.904761,1.984126,2.063492,2.142857,2.222222,2.301587,2.380952,
2.460317,2.539682,2.619047,2.698412,2.777777,2.857142,2.936507,3.015873,3.095238,3.174603,
3.253968,3.333333,3.412698,3.492063,3.571428,3.650793,3.730158,3.809523,3.888888,3.968253,
4.047619,4.126984,4.206349,4.285714,4.365079,4.444444,4.523809,4.603174,4.682539,4.761904,
4.841269,4.920634,5, 5,4.920634,4.841269,4.761904,4.682539,4.603174,4.523809,4.444444,4.365079,4.285714,4.206349,
4.126984,4.047619,3.968253,3.888888,3.809523,3.730158,3.650793,3.571428,3.492063,3.412698,
3.333333,3.253968,3.174603,3.095238,3.015873,2.936507,2.857142,2.777777,2.698412,2.619047,
2.539682,2.460317,2.380952,2.301587,2.222222,2.142857,2.063492,1.984126,1.904761,1.825396,
1.746031,1.666666,1.587301,1.507936,1.428571,1.349206,1.269841,1.190476,1.111111,1.031746,
0.952380,0.873015,0.793650,0.714285,0.634920,0.555555,0.476190,0.396825,0.317460,0.238095,
0.158730,0.079365,0};

float ramp_values[128]={5,4.960629,4.921259,4.881889,4.842519,4.803149,4.763779,4.724409,4.685039,4.645669,4.606299, 
4.566929,4.527559,4.488188,4.448818,4.409448,4.370078,4.330708,4.291338,4.251968,4.212598, 
4.173228,4.133858,4.094488,4.055118,4.015748,3.976377,3.937007,3.897637,3.858267,3.818897, 
3.779527,3.740157,3.700787,3.661417,3.622047,3.582677,3.543307,3.503937,3.464566,3.425196, 
3.385826,3.346456,3.307086,3.267716,3.228346,3.188976,3.149606,3.110236,3.070866,3.031496, 
2.992125,2.952755,2.913385,2.874015,2.834645,2.795275,2.755905,2.716535,2.677165,2.637795, 
2.598425,2.559055,2.519685,2.480314,2.440944,2.401574,2.362204,2.322834,2.283464,2.244094, 
2.204724,2.165354,2.125984,2.086614,2.047244,2.007874,1.968503,1.929133,1.889763,1.850393, 
1.811023,1.771653,1.732283,1.692913,1.653543,1.614173,1.574803,1.535433,1.496062,1.456692, 
1.417322,1.377952,1.338582,1.299212,1.259842,1.220472,1.181102,1.141732,1.102362,1.062992, 
1.023622,0.984251,0.944881,0.905511,0.866141,0.826771,0.787401,0.748031,0.708661,0.669291, 
0.629921,0.590551,0.551181,0.511811,0.472440,0.433070,0.393700,0.354330,0.314960,0.275590, 
0.236220,0.196850,0.157480,0.118110,0.078740,0.039370,0}

float cus_values[128]={3.105517,3.663939,4.134686,4.489156,4.714245,4.813394,4.805059,4.718919,4.590555,4.455519,
4.343842,4.275874,4.260088,4.293125,4.361912,4.447349,4.528771,4.588320,4.614399,4.603599,
4.560834,4.497746,4.429808,4.372778,4.339258,4.336076,4.362995,4.412990,4.473978,4.531617,
4.572532,4.587301,4.572532,4.531617,4.473978,4.412990,4.362995,4.336076,4.339258,4.372778,
4.429808,4.497746,4.560834,4.603599,4.614399,4.588320,4.528771,4.447349,4.361912,4.293125,
4.260088,4.275874,4.343842,4.455519,4.590555,4.718919,4.805059,4.813394,4.714245,4.489156,
4.134686,3.663939,3.105517,2.500000,1.894482,1.336060,0.865313,0.510843,0.285754,0.186605,
0.194940,0.281080,0.409444,0.544480,0.656157,0.724125,0.739911,0.706874,0.638087,0.552650,
0.471228,0.411679,0.385600,0.396400,0.439165,0.502253,0.570191,0.627221,0.660741,0.663923,
0.637004,0.587009,0.526021,0.468382,0.427467,0.412698,0.427467,0.468382,0.526021,0.587009,
0.637004,0.663923,0.660741,0.627221,0.570191,0.502253,0.439165,0.396400,0.385600,0.411679,
0.471228,0.552650,0.638087,0.706874,0.739911,0.724125,0.656157,0.544480,0.409444,0.281080,
0.194940,0.186605,0.285754,0.510843,0.865313,1.336060,1.894482,2.500000};

float sine_values[128]={2.622669,2.745042,2.866826,2.987725,3.107450,3.225711,3.342224,3.456708,3.568887,3.678491,
3.785256,3.888925,3.989248,4.085983,4.178897,4.267766,4.352377,4.432526,4.508018,4.578674,
4.644321,4.704803,4.759973,4.809698,4.853860,4.892350,4.925078,4.951963,4.972941,4.987961,
4.996988,5,4.996988,4.987961,4.972941,4.951963,4.925078,4.892350,4.853860,4.809698,4.759973,4.704803,
4.644321,4.578674,4.508018,4.432526,4.352377,4.267766,4.178897,4.085983,3.989248,3.888925,
3.785256,3.678491,3.568887,3.456708,3.342224,3.225711,3.107450,2.987725,2.866826,2.745042,
2.622669,2.500000,2.377330,2.254957,2.133173,2.012274,1.892549,1.774288,1.657775,1.543291,
1.431112,1.321508,1.214743,1.111074,1.010751,0.914016,0.821102,0.732233,0.647622,0.567473,
0.491981,0.421325,0.355678,0.295196,0.240026,0.190301,0.146139,0.107649,0.074921,0.048036,
0.027058,0.012038,0.003011,0,0.003011,0.012038,0.027058,0.048036,0.074921,0.107649,0.146139,
0.190301,0.240026,0.295196,0.355678,0.421325,0.491981,0.567473,0.647622,0.732233,0.821102,
0.914016,1.010751,1.111074,1.214743,1.321508,1.431112,1.543291,1.657775,1.774288,1.892549,
2.012274,2.133173,2.254957,2.377330,2.500000};


extern DAC_state dac_state;

void init_dac(){
	RCC->APB1ENR1	|=RCC_APB1ENR1_DAC1EN; //enable DAC clock
	DAC1->CR|=DAC_CR_EN2;//enable DAC channel 1
}

void init_dac_GPIO(){
	RCC->AHB2ENR |= RCC_AHB2ENR_GPIOAEN ; //enable clock for GPIO port A
	GPIOA->MODER &=~0x00000C00; // clear mode register for PA5
	GPIOA->MODER|=0x00000C00; //configure PA5  as analog mode
	GPIOA->PUPDR&=~0x00000C00; //set PA5 as no pullup or pulldown
}
	
float sine(int sample){
	float dac_value;
	float function_value=sine_values[normalized_phase];		
	float actual_ref=dac_state.vref/5;
	//if being called from another math function
	dac_value=(function_value/actual_ref)*819;
	else{
		
		DAC1->DHR12R2=(uint32_t)dac_value;//round up
		return 0;
	}
}

void cus(void){
	DAC1->DHR12R2=test;
}

void triangle(void){
	float range=dac_state.vref*DIVS_PER_VOLT;
	if(dac_state.sample%2==0 && dac_state.sample<64){
		DAC1->DHR12R2=ramp_values[dac_state.sample/2]*range;
	}
	else if(dac_state.sample%2==0 && dac_state.sample>=64){
		DAC1->DHR12R2=ramp_values[(127-dac_state.sample)/2]*range;
	}
}

void ramp(void){
	float range=dac_state.vref*DIVS_PER_VOLT;
	if(dac_state.sample%4==0){
		DAC1->DHR12R2=ramp_values[dac_state.sample/4]*range;
	}	
}
